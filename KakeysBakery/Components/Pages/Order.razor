@page "/Order"

@using BlazorBootstrap
@inject NavigationManager navManager
@inject HttpClient client
@rendermode InteractiveServer
@* @attribute [Authorize] *@

<h3 class="pageTitle">Order</h3>


<Modal @ref="modal" Title="Customize Your Order">
    <BodyTemplate>
        <div class="Modal">
            <label>Choose @baseGoodTypes?.Where(c => c.Id == clickedBaseGoodId).FirstOrDefault()?.Basegood Type:</label>
            <select name="flavor" @onchange="SelectHasChanged" id="box">
                <option> --- </option>
                @if (baseGoodDetails is not null)
                {
                    @foreach (Basegood basegoods in baseGoodDetails)
                    {
                        @if (basegoods.Isavalible)
                        {
                            <option value="@basegoods.Flavor?.Id">@basegoods.Flavor?.Flavorname</option>
                        }

                    }
                }
            </select>

            <div class="InputBox">
                <label>Quantity:</label>
                <input type="number" @onchange="QuantityChanged" id="box" />
            </div>
            <hr />
            @if (modalError is null)
            {
                <h5>Price for this amount: @(currentBaseGood?.Suggestedprice * quantity)</h5>
            }
            else
            {
                <p>Error: @modalError</p>
            }
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="async () => { await modal.HideAsync(); }">Close</Button>
        @if (modalError is null)
        {
            <Button Color="ButtonColor.Primary" @onclick="async () => { await AddToCart(); }">Add To Cart</Button>
        }
    </FooterTemplate>
</Modal>

<div class="mt-5 border totalPage">
    <div class="d-flex flex-wrap justify-content-center">
        @if (baseGoodTypes == null)
        {
            <p>Loading products, please wait</p>
        }
        else
        {
            @foreach (Basegoodtype basegoodtype in baseGoodTypes)
            {
                <div class="d-flex position-relative order-container rounded-5 m-3 p-3" @onclick="async () => {await BaseGoodClicked(basegoodtype.Id); await modal.ShowAsync();}">
                    <h3 class="typelabel" style="z-index: 1;">@basegoodtype.Basegood</h3>
                    <img class="imgbutton img-fluid shadow rounded-5 img-thumbnail" src="images/@(basegoodtype.Basegood).jpg">
                </div>
            }
        }
    </div>
</div>


@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    private Modal modal = default!;
    Basegood? currentBaseGood;
    List<Basegood>? baseGoodDetails;
    int clickedBaseGoodId;
    decimal? quantity = 1;
    string? modalError;
    public List<Basegoodtype>? baseGoodTypes = null;


    protected override async Task OnInitializedAsync()
    {
        client.BaseAddress = new Uri(navManager.BaseUri);
        baseGoodTypes = await client.GetFromJsonAsync<List<Basegoodtype>>($"api/Basegoodtype/getall");

        // await AuthenticateUser();
    }

    private async Task SelectHasChanged(ChangeEventArgs e)
    {
        if (e.Value is null) { return; }
        if (e.Value is "---") { return; }

        int typeId = Convert.ToInt32(e.Value.ToString());
        currentBaseGood = await client.GetFromJsonAsync<Basegood>($"api/Basegood/get_from_flavor/{clickedBaseGoodId}/{typeId}");

    }

    private void QuantityChanged(ChangeEventArgs e)
    {
        int testquantity = 1;
        try
        {
            testquantity = Convert.ToInt32(e.Value?.ToString());
            quantity = (decimal)testquantity;
            modalError = null;
        }
        catch
        {
            quantity = 1;
            modalError = "something went wrong, please try again";
        }
        if (testquantity <= 0)
        {
            modalError = "please input a quantity larger than 1";
            quantity = 1;
        }
    }

    public async Task BaseGoodClicked(int basegoodtypeid)
    {
        clickedBaseGoodId = basegoodtypeid;
        baseGoodDetails = await client.GetFromJsonAsync<List<Basegood>>($"api/Basegood/get_from_type/{basegoodtypeid}");
    }

    public async Task AddToCart()
    {
        if (!(await AuthenticateUser()))
        {
            navManager.NavigateTo("Account/Login?redirectUri=/Order");
        }
    }

    private async Task<bool> AuthenticateUser()
    {
        if (authenticationState is null) { return false; }

        var state = await authenticationState;
        if (state is null) { return false; }
        if (state.User.Identity is null) { return false; }

        string? email = GetUserEmail(state);
        if (email == null) { return false; }


        Customer? result = null;
        try {
            result = await client.GetFromJsonAsync<Customer>($"api/customer/get_by_email/{email}");
        }
        catch { }

        if (result is null)
        {
            Customer User = new Customer()
                {
                    Forename = state.User.Identity.Name,
                    Email = state.User.Claims.Where(c => c.Type.Contains("emailaddress")).FirstOrDefault()!.Value
                };
            await client.PostAsJsonAsync("api/customer/add", User);
        }

        return true;
    }

    private string? GetUserEmail(AuthenticationState state)
    {
        var user = state.User.Claims
            .Where(c => c.Type.Contains("emailaddress"))
            .FirstOrDefault();

        if (user is null) { return null; }
        return user.Value;
    }
}