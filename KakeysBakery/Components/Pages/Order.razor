@page "/Order"

@using BlazorBootstrap
@using KakeysBakery.Data
@using Microsoft.EntityFrameworkCore
@inject NavigationManager navManager
@inject HttpClient client
@inject PostgresContext context
@rendermode InteractiveServer

<h3 class="pageTitle">Order</h3>


<Modal @ref="modal" Title="Customize Your Order">
    <BodyTemplate>
        <div class="Modal">
            <table class="table table-borderless">
                <tbody>
                    <tr>
                        <td>
                            <label>Choose @baseGoodTypes?.Where(c => c.Id == clickedBaseGoodId).FirstOrDefault()?.Basegood Type:</label>
                        </td>
                        <td>
                            <select class="form-select" name="flavor" @onchange="SelectHasChanged" id="box">
                                <option> --- </option>
                                @if (baseGoodDetails is not null)
                                {
                                    @foreach (Basegood basegoods in baseGoodDetails)
                                    {
                                        @if (basegoods.Isavailable ?? false)
                                        {
                                            <option value="@basegoods.Flavor?.Id">@basegoods.Flavor?.Flavorname</option>
                                        }

                                    }
                                }
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>Quantity:</label>
                        </td>
                        <td>
                            <div class="InputBox">
                                <input class="form-control" min="1" type="number" @onchange="QuantityChanged" id="box" />
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <hr />
            @if (modalError is null)
            {
                <h5>Total: $@(currentBaseGood?.Suggestedprice * quantity)</h5>
            }
            else
            {
                <p class="text-danger">* Error: @modalError</p>
            }
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="async () => { await modal.HideAsync(); }">Close</Button>
        @if (modalError is null)
        {
            <Button Color="ButtonColor.Primary" @onclick="async () => { await AddToCart(); }">Add To Cart</Button>
        }
    </FooterTemplate>
</Modal>

<div class="mt-5 border totalPage">
    <div class="d-flex flex-wrap justify-content-center">
        @if (baseGoodTypes == null)
        {
            <p>Loading products, please wait</p>
        }
        else
        {
            @foreach (Basegoodtype basegoodtype in baseGoodTypes)
            {
                <div class="d-flex position-relative order-container rounded-5 m-3 p-3" @onclick="async () => {await BaseGoodClicked(basegoodtype.Id); await modal.ShowAsync();}">
                    <h3 class="typelabel" style="z-index: 1;">@basegoodtype.Basegood</h3>
                    <img class="imgbutton img-fluid shadow rounded-5 img-thumbnail" src="images/@(basegoodtype.Basegood).jpg">
                </div>
            }
        }
    </div>
</div>


@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }
    private AuthenticationManager? authManager;

    private Modal modal = default!;
    List<Basegood>? baseGoodDetails = null;
    public List<Basegoodtype>? baseGoodTypes = null;

    Basegood? currentBaseGood;
    int clickedBaseGoodId;
    int? quantity = 1;
    string? modalError;


    protected override async Task OnInitializedAsync()
    {
        client.BaseAddress = new Uri(navManager.BaseUri);
        baseGoodTypes = await client.GetFromJsonAsync<List<Basegoodtype>>($"api/Basegoodtype/getall");

        authManager = new(authenticationState, client);
    }

    private async Task SelectHasChanged(ChangeEventArgs e)
    {
        if (e.Value is null) { return; }
        if (e.Value is "---") { return; }

        int typeId = Convert.ToInt32(e.Value.ToString());
        currentBaseGood = await client.GetFromJsonAsync<Basegood>($"api/Basegood/get_from_flavor/{clickedBaseGoodId}/{typeId}");
    }

    private void QuantityChanged(ChangeEventArgs e)
    {
        if (e.Value == null) { return; }
        quantity = 1;

        try
        {
            quantity = Convert.ToInt32(e.Value.ToString());
            modalError = null;
        }
        catch
        {
            modalError = "Something went wrong, please try again";
        }

        if (quantity <= 0)
        {
            modalError = "Please input a quantity larger than 0";
        }
    }

    public async Task BaseGoodClicked(int basegoodtypeid)
    {
        clickedBaseGoodId = basegoodtypeid;
        baseGoodDetails = await client.GetFromJsonAsync<List<Basegood>>($"api/Basegood/get_from_type/{basegoodtypeid}");
    }

    public async Task AddToCart()
    {
        if (!(await authManager!.IsUserLoggedIn()))
        {
            navManager.NavigateTo("Account/Login?redirectUri=/Order");
            return;
        }

        Product? product = await GetProduct();
        if (product == null) { return; }

        Cart c = new()
            {
                Customerid = 0, // TODO: Get customer id
                Productid = product.Id,
                Quantity = quantity
            };

        // Save to database
        // context.Carts.Add(c);
        // await context.SaveChangesAsync();
    }

    private async Task<Product?> GetProduct()
    {
        int bgId = 0; // TODO: Get basegood id

        var pabs = await context.ProductAddonBasegoods
            .Include(p => p.Basegood)
            .Where(p => p.Basegood.Pastryid == 0) // TODO: Get pastry id
            .Where(p => p.Basegoodid == bgId)
            .Where(p => p.Addon == null)
            .FirstOrDefaultAsync();

        Product? product;
        if (pabs is null)
        {
            var pCount = context.Products.Count() + 1;

            product = new()
                {
                    Id = pCount,
                    Ispublic = true
                };

            pabs = new()
                {
                    Productid = pCount,
                    Basegoodid = bgId
                };

            context.Products.Add(product);
            context.ProductAddonBasegoods.Add(pabs);

            // await context.SaveChangesAsync();
        }

        else
        {
            product = await context.Products
                .Where(p => p.Id == pabs.Productid)
                .FirstOrDefaultAsync();
        }

        return product;
    }
}